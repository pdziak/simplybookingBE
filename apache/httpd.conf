ServerName localhost

# --- Base includes ---
LoadModule mpm_event_module modules/mod_mpm_event.so
LoadModule dir_module modules/mod_dir.so
LoadModule mime_module modules/mod_mime.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule alias_module modules/mod_alias.so
LoadModule headers_module modules/mod_headers.so
LoadModule setenvif_module modules/mod_setenvif.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so
LoadModule socache_shmcb_module modules/mod_socache_shmcb.so
LoadModule unixd_module modules/mod_unixd.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule authz_host_module modules/mod_authz_host.so
LoadModule access_compat_module modules/mod_access_compat.so
LoadModule deflate_module modules/mod_deflate.so
LoadModule lbmethod_byrequests_module modules/mod_lbmethod_byrequests.so

User daemon
Group daemon
ServerTokens Prod
ServerSignature Off
Listen 80

# Logging
ErrorLog /proc/self/fd/2
LogLevel warn
CustomLog /proc/self/fd/1 combined

# MIME
TypesConfig conf/mime.types
DirectoryIndex index.php index.html

# --- VirtualHost serving API (dev + prod hostnames) ---
<VirtualHost *:80>
  ServerName benefitowo.webdev
  ServerAlias api.benefitowo.pl

  DocumentRoot "/var/www/html/public"

  <Directory "/var/www/html/public">
    # Let Symfony/.htaccess handle front controller
    AllowOverride All
    Require all granted
    Options -Indexes +FollowSymLinks
  </Directory>


    # Ensure Authorization header reaches PHP-FPM
    SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1

    # If behind proxies that might strip headers:
    RewriteEngine On
    RewriteCond %{HTTP:Authorization} ^(.*)
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%1]
  # -------------------- CORS --------------------
  # Allowed origins:
  #   - http://benefitowo.webdev:3000
  #   - http://*.benefitowo.webdev:3000
  #   - http/https://*.benefitowo.pl (any port)
  SetEnvIf Origin "^http://benefitowo\.webdev:3000$" ORIGIN_ALLOWED=$0
  SetEnvIf Origin "^http://([a-z0-9-]+\.)*benefitowo\.webdev:3000$" ORIGIN_ALLOWED=$0 nocase
  SetEnvIf Origin "^https?://([a-z0-9-]+\.)*benefitowo\.pl(:\d+)?$" ORIGIN_ALLOWED=$0 nocase

  # CORS headers (always, including errors)
  Header always set Access-Control-Allow-Origin "%{ORIGIN_ALLOWED}e" env=ORIGIN_ALLOWED
  Header always set Access-Control-Allow-Credentials "true"
  Header always set Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
  Header always set Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With"
  Header always set Access-Control-Expose-Headers "Link, Location"
  Header always set Vary "Origin"

  # Preflight detection
  SetEnvIfNoCase Request_Method "OPTIONS" IS_OPTIONS=1

  # Add preflight-only headers
  Header always set Access-Control-Max-Age "86400" env=IS_OPTIONS
  Header always set Content-Length "0" env=IS_OPTIONS
  Header always set Content-Type "text/plain; charset=UTF-8" env=IS_OPTIONS

  # Short-circuit OPTIONS with 204 so it never reaches PHP
  RewriteEngine On
  RewriteCond %{ENV:IS_OPTIONS} =1
  RewriteRule ^ - [R=204]

  # ---------------- PHP-FPM via proxy_fcgi ----------------
  # Send *.php to the PHP-FPM container (apip-php:9000)
  # IMPORTANT: both DocumentRoot and the path in the fcgi URL must match the same filesystem path.
  ProxyTimeout 60
  ProxyPassMatch "^/(.*\.php(/.*)?)$" "fcgi://apip-php:9000/var/www/html/public/$1"

  # Security: block sensitive files from being served directly
  <LocationMatch "\.(yaml|yml|env|twig|lock|dist|md|git|gitignore|gitattributes)$">
    Require all denied
  </LocationMatch>

  # (Optional) static caching
  <LocationMatch "\.(ico|css|js|gif|jpe?g|png|svg|webp|avif|woff2?)$">
    Header set Cache-Control "max-age=3600, public"
  </LocationMatch>
</VirtualHost>
